<!DOCTYPE html>
<html>
<head>
  <title>Shopify Orders</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .json-modal {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 20px;
      border: 1px solid #ccc;
      max-width: 400px;
      max-height: 80vh;
      overflow: auto;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <h2>Latest Shopify Orders</h2>
  <div id="orders-container"></div>
  <div id="json-modal" class="json-modal" style="display: none;"></div>

  <script>
    const modal = document.getElementById('json-modal');
    let eventSource;

    function loadOrders() {
      fetch('/api/orders')
        .then(r => r.json())
        .then(orders => {
          const html = `
            <table>
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Order Number</th>
                  <th>Customer</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${orders.map(order => `
                  <tr>
                    <td>${order.id || ''}</td>
                    <td>${order.order_number || ''}</td>
                    <td>${order.shipping_address?.name || ''}</td>
                    <td>${order.customer?.email || ''}</td>
                    <td>${order.shipping_address?.phone || ''}</td>
                    <td>
                      <button onclick="showOrderDetails('${order.id}')">
                        Show Details
                      </button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>`;
          document.getElementById('orders-container').innerHTML = html;
        })
        .catch(err => console.error('Error loading orders:', err));
    }

    function showOrderDetails(orderId) {
      fetch(`/api/orders/${orderId}`)
        .then(r => r.json())
        .then(order => {
          modal.style.display = 'block';
          modal.innerHTML = `
            <h3>Order Details</h3>
            <pre>${JSON.stringify({
              name: order.shipping_address?.name,
              email: order.customer?.email,
              phone: order.shipping_address?.phone,
              shipping_code: order.shipping_lines?.[0]?.code,
              address: `${order.shipping_address?.address1 || ''} ${order.shipping_address?.address2 || ''}`.trim(),
              city: order.shipping_address?.city,
              country: order.shipping_address?.country
            }, null, 2)}</pre>
            <button onclick="modal.style.display='none'">Close</button>
          `;
        })
        .catch(err => console.error('Error loading order details:', err));
    }

    // SSE listener
    eventSource = new EventSource('/events');
    eventSource.onmessage = () => loadOrders();

    // Initial load
    loadOrders();
  </script>
</body>
</html>