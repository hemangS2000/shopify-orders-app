<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shopify Orders</title>
  <style>
    /* Keep existing styles */
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f2f2f2; }
    button { padding: 6px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    .no-shipping { background-color: #ffdddd; }
    .home-delivery { color: #666; font-style: italic; }
  </style>
</head>
<body>
  <h1>Shopify Orders</h1>
  <table>
    <thead>
      <tr>
        <th>Source</th>
        <th>Order #</th>
        <th>Customer Info</th>
        <th>Item Count</th>
        <th>Pickup Action</th>
      </tr>
    </thead>
    <tbody id="orders-table-body"></tbody>
  </table>

  <script>
    let currentOrders = [];

    async function loadOrders() {
      try {
        const res = await fetch('/api/orders');
        currentOrders = await res.json();
        renderOrders();
      } catch (err) {
        console.error('Error loading orders:', err);
      }
    }

    const eventSource = new EventSource('/events');
    eventSource.onmessage = () => {
      loadOrders();
    };

    function renderOrders() {
      const tbody = document.getElementById('orders-table-body');
      tbody.innerHTML = currentOrders.map((order, index) => {
        const requiresShipping = order.line_items.some(item => item.requires_shipping);
        const shippingMethod = order.shipping_lines?.[0]?.title || 'No shipping';
        const isPickupPoint = shippingMethod === 'Standard Pickup-Point';
        
        const rowClass = requiresShipping ? '' : 'no-shipping';
        
        let pickupActionContent;
        if (!requiresShipping) {
          pickupActionContent = 'Digital product';
        } else if (isPickupPoint) {
          pickupActionContent = `<button onclick='sendToApi(${JSON.stringify(order)}, "pickup-${index}")'>Send to API</button>`;
        } else {
          pickupActionContent = `<span class="home-delivery">${shippingMethod}</span>`;
        }

        return `
          <tr class="${rowClass}">
            <td>${order.source_name}</td>
            <td>${order.order_number}</td>
            <td>
              ${order.shipping_address?.name || 'N/A'}<br>
              ${order.customer.email}<br>
              ${order.shipping_address?.phone || 'N/A'}<br>
              ${order.shipping_address ? [
                order.shipping_address.address1,
                order.shipping_address.address2,
                order.shipping_address.zip,
                order.shipping_address.city,
                order.shipping_address.country
              ].filter(Boolean).map(item => `${item}<br>`).join('') : 'No shipping address'}
            </td>
            <td>${order.line_items.length}</td>
            <td id="pickup-${index}">
              ${pickupActionContent}
            </td>
          </tr>
        `;
      }).join('');
    }

    // Keep existing sendToApi function
    async function sendToApi(order, elementId) {
      // ... (keep your existing implementation) ...
    }

    // Initial load
    loadOrders();
  </script>
</body>
</html>